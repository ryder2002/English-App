generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    Int                    @id @default(autoincrement())
  email                 String                 @unique
  password              String
  name                  String?
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  firebaseUid           String?                @unique @map("firebase_uid")
  resetToken            String?                @map("reset_token")
  resetTokenExpiry      DateTime?              @map("reset_token_expiry")
  lastLoginAt           DateTime?              @map("last_login_at")
  role                  Role                   @default(user)
  chatConversations     ChatConversation[]
  classActivitySessions ClassActivitySession[]
  classesJoined         ClassMember[]
  classesOwned          Clazz[]                @relation("ClassTeacher")
  folders               Folder[]
  homeworkSubmissions   HomeworkSubmission[]
  speakingSubmissions   SpeakingSubmission[]
  quizResults           QuizResult[]
  vocabulary            Vocabulary[]

  @@map("users")
}

model Folder {
  id        Int      @id @default(autoincrement())
  name      String
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  parentId  Int?     @map("parent_id")
  parent    Folder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children  Folder[] @relation("FolderHierarchy")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizzes   Quiz[]

  @@unique([name, userId, parentId])
  @@map("folders")
}

model Vocabulary {
  id                    Int      @id @default(autoincrement())
  word                  String
  language              Language
  vietnameseTranslation String   @map("vietnamese_translation")
  folder                String
  partOfSpeech          String?  @map("part_of_speech")
  ipa                   String?
  pinyin                String?
  audioSrc              String?  @map("audio_src")
  userId                Int      @map("user_id")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  example               String?  @map("example")
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([folder])
  @@index([language])
  @@map("vocabulary")
}

model Clazz {
  id                    Int                    @id @default(autoincrement())
  name                  String
  description           String?
  classCode             String                 @unique @map("class_code")
  teacherId             Int                    @map("teacher_id")
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  classActivitySessions ClassActivitySession[]
  members               ClassMember[]
  teacher               User                   @relation("ClassTeacher", fields: [teacherId], references: [id], onDelete: Cascade)
  homeworks             Homework[]
  quizzes               Quiz[]

  @@map("classes")
}

model ClassMember {
  id       Int      @id @default(autoincrement())
  clazzId  Int      @map("class_id")
  userId   Int      @map("user_id")
  joinedAt DateTime @default(now()) @map("joined_at")
  clazz    Clazz    @relation(fields: [clazzId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clazzId, userId])
  @@map("class_members")
}

model Quiz {
  id              Int           @id @default(autoincrement())
  title           String
  description     String?
  quizCode        String        @unique @map("test_code")
  clazzId         Int           @map("class_id")
  folderId        Int           @map("folder_id")
  status          QuizStatus    @default(pending) @map("status")
  timePerQuestion Int?          @default(0) @map("time_per_question")
  direction       QuizDirection @default(en_vi) @map("direction")
  isPaused        Boolean       @default(false) @map("is_paused")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  endedAt         DateTime?     @map("ended_at")
  results         QuizResult[]
  clazz           Clazz         @relation(fields: [clazzId], references: [id], onDelete: Cascade)
  folder          Folder        @relation(fields: [folderId], references: [id])

  @@map("tests")
}

model QuizResult {
  id        Int                @id @default(autoincrement())
  quizId    Int                @map("test_id")
  userId    Int                @map("user_id")
  score     Float
  maxScore  Float              @map("max_score")
  startedAt DateTime           @default(now()) @map("started_at")
  endedAt   DateTime?          @map("ended_at")
  status    QuizResultStatus   @default(in_progress) @map("status")
  answers   QuizAnswerDetail[]
  quiz      Quiz               @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("test_results")
}

model QuizAnswerDetail {
  id             Int        @id @default(autoincrement())
  resultId       Int        @map("result_id")
  vocabularyId   Int?       @map("vocabulary_id")
  questionText   String     @map("question_text")
  questionType   String     @map("question_type")
  selectedAnswer String     @map("selected_answer")
  correctAnswer  String     @map("correct_answer")
  isCorrect      Boolean    @map("is_correct")
  answeredAt     DateTime   @default(now()) @map("answered_at")
  result         QuizResult @relation(fields: [resultId], references: [id], onDelete: Cascade)

  @@map("quiz_answer_details")
}

model SystemNotification {
  id        Int              @id @default(autoincrement())
  title     String
  content   String
  type      NotificationType @default(info)
  isActive  Boolean          @default(true) @map("is_active")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")
  createdBy Int?             @map("created_by")

  @@map("system_notifications")
}

model Homework {
  id                  Int                  @id @default(autoincrement())
  title               String
  description         String?
  type                HomeworkType
  clazzId             Int                  @map("class_id")
  deadline            DateTime
  status              HomeworkStatus       @default(active)
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @updatedAt @map("updated_at")
  audioUrl            String?              @map("audio_url")
  answerText          String?              @map("answer_text")
  promptText          String?              @map("prompt_text")
  hideMode            HomeworkHideMode?    @default(all) @map("hide_mode")
  content             String?
  answerBoxes         Json?                @map("answer_boxes")
  speakingText        String?              @map("speaking_text")
  clazz               Clazz                @relation(fields: [clazzId], references: [id], onDelete: Cascade)
  submissions         HomeworkSubmission[]
  speakingSubmissions SpeakingSubmission[]

  @@map("homework")
}

model HomeworkSubmission {
  id               Int                      @id @default(autoincrement())
  homeworkId       Int                      @map("homework_id")
  userId           Int                      @map("user_id")
  attemptNumber    Int                      @default(1) @map("attempt_number")
  answer           String?
  answers          Json?                    @map("answers")
  boxResults       Json?                    @map("box_results")
  score            Float?
  status           HomeworkSubmissionStatus @default(in_progress)
  submittedAt      DateTime?                @map("submitted_at")
  startedAt        DateTime?                @map("started_at")
  lastActivityAt   DateTime?                @map("last_activity_at")
  timeSpentSeconds Int                      @default(0) @map("time_spent_seconds")
  createdAt        DateTime                 @default(now()) @map("created_at")
  updatedAt        DateTime                 @updatedAt @map("updated_at")
  audioData        Bytes?                   @map("audio_data")
  transcribedText  String?                  @map("transcribed_text")
  audioUrl         String?                  @map("audio_url")
  voiceAnalysis    Json?                    @map("voice_analysis")
  homework         Homework                 @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  user             User                     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([homeworkId, userId, attemptNumber])
  @@index([homeworkId, userId])
  @@map("homework_submissions")
}

model SpeakingSubmission {
  id              Int      @id @default(autoincrement())
  homeworkId      Int      @map("homework_id")
  userId          Int      @map("user_id")
  transcribedText String?  @map("transcribed_text")
  score           Float    @default(0)
  audioUrl        String?  @map("audio_url")
  voiceAnalysis   Json?    @map("voice_analysis")
  submittedAt     DateTime @default(now()) @map("submitted_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  attemptNumber   Int      @default(1) @map("attempt_number")
  status          String   @default("submitted")
  homework        Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([homeworkId])
  @@index([userId])
  @@map("speaking_submissions")
}

model ClassActivitySession {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  clazzId         Int       @map("class_id")
  startedAt       DateTime  @default(now()) @map("started_at")
  endedAt         DateTime? @map("ended_at")
  durationSeconds Int?      @map("duration_seconds")
  createdAt       DateTime  @default(now()) @map("created_at")
  clazz           Clazz     @relation(fields: [clazzId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([clazzId])
  @@index([userId])
  @@map("class_activity_sessions")
}

model ChatConversation {
  id        Int           @id @default(autoincrement())
  userId    Int           @map("user_id")
  title     String        @default("New Chat")
  createdAt DateTime      @default(now()) @map("created_at")
  updatedAt DateTime      @updatedAt @map("updated_at")
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@index([userId])
  @@map("chat_conversations")
}

model ChatMessage {
  id             Int              @id @default(autoincrement())
  conversationId Int              @map("conversation_id")
  role           String
  content        String
  createdAt      DateTime         @default(now()) @map("created_at")
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("chat_messages")
}

enum Language {
  english
  chinese
  vietnamese
}

enum Role {
  admin
  user
}

enum QuizStatus {
  pending
  active
  ended
}

enum QuizResultStatus {
  in_progress
  completed
  submitted
}

enum QuizDirection {
  en_vi
  vi_en
  random
}

enum NotificationType {
  info
  warning
  maintenance
  update
  important
}

enum HomeworkType {
  listening
  reading
  speaking
}

enum HomeworkStatus {
  active
  locked
  archived
}

enum HomeworkHideMode {
  all
  random
}

enum HomeworkSubmissionStatus {
  in_progress
  submitted
  graded
}
